<Window x:Class="MeshhessenClient.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:ui="http://schemas.modernwpf.com/2019"
        xmlns:mapsui="clr-namespace:Mapsui.UI.Wpf;assembly=Mapsui.UI.Wpf"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:converters="clr-namespace:MeshhessenClient.Converters"
        mc:Ignorable="d"
        ui:WindowHelper.UseModernWindowStyle="True"
        Icon="pack://application:,,,/Resources/app.ico"
        Title="Meshhessen Client"
        Height="600"
        Width="900"
        MinHeight="400"
        MinWidth="600">
    <Window.Resources>
        <converters:MqttIconConverter x:Key="MqttIconConverter"/>
        <converters:MqttTooltipConverter x:Key="MqttTooltipConverter"/>

        <Style TargetType="ComboBoxItem">
            <Setter Property="Foreground" Value="{DynamicResource SystemControlForegroundBaseHighBrush}"/>
        </Style>
    </Window.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Toolbar -->
        <Border Grid.Row="0" Background="{DynamicResource SystemControlBackgroundChromeMediumBrush}" Padding="10">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <!-- Connection Controls -->
                <StackPanel Grid.Column="0" Orientation="Horizontal">
                    <TextBlock Text="COM Port:" VerticalAlignment="Center" Margin="0,0,10,0"/>
                    <ComboBox x:Name="PortComboBox"
                             Width="120"
                             VerticalAlignment="Center"
                             SelectionChanged="PortComboBox_SelectionChanged"/>
                    <Button x:Name="RefreshPortsButton"
                           Content="🔄"
                           Margin="5,0,0,0"
                           Width="45"
                           ToolTip="Ports aktualisieren"
                           Click="RefreshPorts_Click"/>
                    <Button x:Name="ConnectButton"
                           Content="Verbinden"
                           Margin="10,0,0,0"
                           Click="Connect_Click"/>
                    <TextBlock x:Name="StationNameLabel"
                               Text=""
                               FontSize="16"
                               FontWeight="Bold"
                               Foreground="Red"
                               VerticalAlignment="Center"
                               Margin="15,0,0,0"/>
                </StackPanel>

                <!-- Connection Status -->
                <StackPanel Grid.Column="1" Orientation="Horizontal">
                    <Button x:Name="OpenDmWindowButton"
                           Content="💬 DMs"
                           Margin="0,0,10,0"
                           Click="OpenDmWindow_Click"
                           ToolTip="Direktnachrichten öffnen"/>
                    <Ellipse x:Name="StatusIndicator"
                            Width="12"
                            Height="12"
                            Fill="Gray"
                            Margin="0,0,8,0"/>
                    <TextBlock x:Name="StatusText"
                              Text="Nicht verbunden"
                              VerticalAlignment="Center"/>
                </StackPanel>
            </Grid>
        </Border>

        <!-- Main Content Area -->
        <TabControl Grid.Row="1" Margin="0">

            <!-- Messages Tab -->
            <TabItem Header="📨 Nachrichten">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>

                    <!-- Message Filter -->
                    <Grid Grid.Row="0" Margin="10,10,10,5">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        <TextBlock Grid.Column="0" Text="Kanal filtern:" VerticalAlignment="Center" Margin="0,0,10,0"/>
                        <ComboBox x:Name="MessageChannelFilterComboBox"
                                 Grid.Column="1"
                                 Width="200"
                                 VerticalAlignment="Center"
                                 SelectionChanged="MessageChannelFilter_Changed"
                                 DisplayMemberPath="Name"/>
                        <Image x:Name="mh_logo_wide_top" Grid.Column="2" Height="56" Width="286"
                               Source="/logo_mh_wide.jpg" HorizontalAlignment="Right"/>
                    </Grid>

                    <!-- Message List -->
                    <ListView x:Name="MessageListView"
                             Grid.Row="1"
                             Margin="10,5,10,10">
                        <ListView.View>
                            <GridView>
                                <GridViewColumn Header="" Width="30">
                                    <GridViewColumn.CellTemplate>
                                        <DataTemplate>
                                            <TextBlock Text="{Binding IsViaMqtt, Converter={StaticResource MqttIconConverter}}"
                                                       ToolTip="{Binding IsViaMqtt, Converter={StaticResource MqttTooltipConverter}}"
                                                       FontSize="16"
                                                       HorizontalAlignment="Center"/>
                                        </DataTemplate>
                                    </GridViewColumn.CellTemplate>
                                </GridViewColumn>
                                <GridViewColumn Header="Zeit" Width="120" DisplayMemberBinding="{Binding Time}"/>
                                <GridViewColumn Header="Von" Width="150" DisplayMemberBinding="{Binding From}"/>
                                <GridViewColumn Header="Nachricht" Width="370" DisplayMemberBinding="{Binding Message}"/>
                                <GridViewColumn Header="Kanal" Width="100" DisplayMemberBinding="{Binding ChannelName}"/>
                            </GridView>
                        </ListView.View>
                    </ListView>

                    <!-- Send Message -->
                    <Grid Grid.Row="2" Margin="10">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>

                        <!-- Channel Selection -->
                        <StackPanel Grid.Column="0" Orientation="Horizontal" VerticalAlignment="Center" Margin="0,0,10,0">
                            <TextBlock Text="Kanal:" VerticalAlignment="Center" Margin="0,0,10,0" FontWeight="Bold"/>
                            <ComboBox x:Name="ActiveChannelComboBox"
                                     Width="150"
                                     VerticalAlignment="Center"
                                     SelectionChanged="ActiveChannelComboBox_SelectionChanged"
                                     DisplayMemberPath="Name"
                                     IsEnabled="False"/>
                        </StackPanel>

                        <TextBox x:Name="MessageTextBox"
                                Grid.Column="1"
                                ui:ControlHelper.PlaceholderText="Nachricht eingeben..."
                                VerticalContentAlignment="Center"
                                Padding="10"
                                KeyDown="MessageTextBox_KeyDown"/>

                        <Button x:Name="SendButton"
                               Grid.Column="2"
                               Content="Senden"
                               Width="100"
                               Margin="10,0,0,0"
                               Click="Send_Click"/>
                    </Grid>
                </Grid>
            </TabItem>

            <!-- Nodes Tab -->
            <TabItem Header="🌐 Knoten">
                <Grid Margin="10">
                    <ListView x:Name="NodesListView">
                        <ListView.View>
                            <GridView>
                                <GridViewColumn Header="Name" Width="150" DisplayMemberBinding="{Binding Name}"/>
                                <GridViewColumn Header="ID" Width="120" DisplayMemberBinding="{Binding Id}"/>
                                <GridViewColumn Header="Entfernung" Width="100" DisplayMemberBinding="{Binding Distance}"/>
                                <GridViewColumn Header="SNR" Width="80" DisplayMemberBinding="{Binding Snr}"/>
                                <GridViewColumn Header="Batterie" Width="80" DisplayMemberBinding="{Binding Battery}"/>
                                <GridViewColumn Header="Zuletzt gesehen" Width="150" DisplayMemberBinding="{Binding LastSeen}"/>
                            </GridView>
                        </ListView.View>
                        <ListView.ContextMenu>
                            <ContextMenu>
                                <MenuItem Header="💬 DM senden" Click="SendDmToNode_Click"/>
                            </ContextMenu>
                        </ListView.ContextMenu>
                    </ListView>
                </Grid>
            </TabItem>

            <!-- Channels Tab -->
            <TabItem Header="📡 Kanäle">
                <Grid Margin="10">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>

                    <ListView x:Name="ChannelsListView" Grid.Row="0">
                        <ListView.View>
                            <GridView>
                                <GridViewColumn Header="Index" Width="60" DisplayMemberBinding="{Binding Index}"/>
                                <GridViewColumn Header="Name" Width="150" DisplayMemberBinding="{Binding Name}"/>
                                <GridViewColumn Header="PSK" Width="300" DisplayMemberBinding="{Binding Psk}"/>
                                <GridViewColumn Header="Role" Width="100" DisplayMemberBinding="{Binding Role}"/>
                            </GridView>
                        </ListView.View>
                    </ListView>

                    <StackPanel Grid.Row="1" Orientation="Horizontal" Margin="0,10,0,0">
                        <Button Content="Kanal hinzufügen" Margin="0,0,10,0" Click="AddChannel_Click"/>
                        <Button Content="Kanal bearbeiten" Margin="0,0,10,0" Click="EditChannel_Click"/>
                        <Button Content="Kanal löschen" Click="DeleteChannel_Click"/>
                    </StackPanel>
                </Grid>
            </TabItem>

            <!-- Settings Tab -->
            <TabItem Header="⚙️ Einstellungen">
                <ScrollViewer VerticalScrollBarVisibility="Auto">
                    <StackPanel Margin="20">
                        <TextBlock Text="Geräteeinstellungen" FontSize="18" FontWeight="Bold" Margin="0,0,0,20"/>

                        <GroupBox Header="Radio Einstellungen" Margin="0,0,0,20">
                            <StackPanel Margin="10">
                                <StackPanel Orientation="Horizontal" Margin="0,10,0,10">
                                    <TextBlock Text="Region:" Width="150" VerticalAlignment="Center"/>
                                    <ComboBox x:Name="RegionComboBox" Width="200"/>
                                </StackPanel>
                                <StackPanel Orientation="Horizontal" Margin="0,10,0,10">
                                    <TextBlock Text="Modem Preset:" Width="150" VerticalAlignment="Center"/>
                                    <ComboBox x:Name="ModemPresetComboBox" Width="200"/>
                                </StackPanel>
                            </StackPanel>
                        </GroupBox>

                        <GroupBox Header="Geräteinfo" Margin="0,0,0,20">
                            <StackPanel Margin="10">
                                <StackPanel Orientation="Horizontal" Margin="0,10,0,10">
                                    <TextBlock Text="Name:" Width="150" VerticalAlignment="Center"/>
                                    <TextBox x:Name="DeviceNameTextBox" Width="200"/>
                                </StackPanel>
                                <StackPanel Orientation="Horizontal" Margin="0,10,0,10">
                                    <TextBlock Text="Hardware Model:" Width="150" VerticalAlignment="Center"/>
                                    <TextBlock x:Name="HardwareModelText" Width="200"/>
                                </StackPanel>
                                <StackPanel Orientation="Horizontal" Margin="0,10,0,10">
                                    <TextBlock Text="Firmware Version:" Width="150" VerticalAlignment="Center"/>
                                    <TextBlock x:Name="FirmwareVersionText" Width="200"/>
                                </StackPanel>
                            </StackPanel>
                        </GroupBox>

                        <GroupBox Header="Darstellung" Margin="0,0,0,20">
                            <StackPanel Margin="10">
                                <StackPanel Orientation="Horizontal" Margin="0,10,0,10">
                                <TextBlock Text="Stationsname:" Width="150" VerticalAlignment="Center"/>
                                <TextBox x:Name="StationNameTextBox" Width="200"/>
                            </StackPanel>
                            <TextBlock Text="Wird rechts neben dem Verbinden-Button angezeigt."
                                      FontStyle="Italic"
                                      Foreground="Gray"
                                      TextWrapping="Wrap"
                                      Margin="20,0,0,10"/>
                        <CheckBox x:Name="DarkModeCheckBox"
                                         Content="Dark Mode"
                                         Margin="0,10,0,10"
                                         IsChecked="False"
                                         Checked="DarkMode_Changed"
                                         Unchecked="DarkMode_Changed"/>
                                <TextBlock Text="Dunkles Farbschema für die Anwendung."
                                          FontStyle="Italic"
                                          Foreground="Gray"
                                          TextWrapping="Wrap"
                                          Margin="20,0,0,10"/>
                            </StackPanel>
                        </GroupBox>

                        <GroupBox Header="Nachrichten Anzeige" Margin="0,0,0,20">
                            <StackPanel Margin="10">
                                <CheckBox x:Name="ShowEncryptedMessagesCheckBox"
                                         Content="Verschlüsselte Nachrichten anzeigen (ohne PSK)"
                                         Margin="0,10,0,10"
                                         IsChecked="True"/>
                                <TextBlock Text="Wenn deaktiviert, werden verschlüsselte Nachrichten ausgeblendet."
                                          FontStyle="Italic"
                                          Foreground="Gray"
                                          TextWrapping="Wrap"
                                          Margin="20,0,0,10"/>
                            </StackPanel>
                        </GroupBox>

                        <GroupBox Header="Karte / Offline Tiles" Margin="0,0,0,20">
                            <StackPanel Margin="10">
                                <TextBlock Text="OSM Tiles herunterladen und im Ordner 'maptiles' speichern."
                                          FontStyle="Italic"
                                          Foreground="Gray"
                                          TextWrapping="Wrap"
                                          Margin="0,0,0,10"/>
                                <Button Content="Tiles herunterladen..."
                                       Width="200"
                                       HorizontalAlignment="Left"
                                       Click="DownloadTiles_Click"/>
                            </StackPanel>
                        </GroupBox>

                        <Button Content="Einstellungen speichern"
                               Width="200"
                               HorizontalAlignment="Left"
                               Click="SaveSettings_Click"/>
                    </StackPanel>
                </ScrollViewer>
            </TabItem>

            <!-- Karte Tab -->
            <TabItem Header="🗺️ Karte">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>
                    <Grid Grid.Row="0" Margin="10,5">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        <StackPanel Grid.Column="0" Orientation="Horizontal">
                            <Button Content="+" Width="32" Height="32" Margin="0,0,4,0"
                                    Click="MapZoomIn_Click" ToolTip="Zoom In"/>
                            <Button Content="-" Width="32" Height="32" Margin="0,0,10,0"
                                    Click="MapZoomOut_Click" ToolTip="Zoom Out"/>
                        </StackPanel>
                        <TextBlock x:Name="MapStatusText" Grid.Column="1" VerticalAlignment="Center" Foreground="Gray" FontStyle="Italic"/>
                    </Grid>
                    <mapsui:MapControl x:Name="MapControl" Grid.Row="1"/>
                </Grid>
            </TabItem>

            <!-- Debug Tab -->
            <TabItem Header="🐛 Debug">
                <Grid Margin="10">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>

                    <!-- Debug Controls -->
                    <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="0,0,0,10">
                        <Button x:Name="ClearLogButton"
                               Content="Log löschen"
                               Click="ClearLog_Click"
                               Margin="0,0,10,0"/>
                        <Button x:Name="CopyLogButton"
                               Content="Log kopieren"
                               Click="CopyLog_Click"
                               Margin="0,0,10,0"/>
                        <Button x:Name="OpenLogFileButton"
                               Content="Log-Datei öffnen"
                               Click="OpenLogFile_Click"/>
                    </StackPanel>

                    <!-- Debug Log Output -->
                    <TextBox x:Name="DebugLogTextBox"
                            Grid.Row="1"
                            IsReadOnly="True"
                            FontFamily="Consolas"
                            FontSize="12"
                            VerticalScrollBarVisibility="Auto"
                            HorizontalScrollBarVisibility="Auto"
                            TextWrapping="NoWrap"
                            Background="{DynamicResource SystemControlBackgroundBaseBrush}"/>
                </Grid>
            </TabItem>

        </TabControl>

        <!-- Status Bar -->
        <Border Grid.Row="2" Background="{DynamicResource SystemControlBackgroundChromeMediumLowBrush}" Padding="10,5">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <TextBlock x:Name="StatusBarText"
                          Text="Bereit"
                          VerticalAlignment="Center"/>

                <TextBlock x:Name="PacketCountText"
                          Grid.Column="1"
                          Text="Pakete: 0"
                          Margin="0,0,20,0"
                          VerticalAlignment="Center"/>

                <StackPanel Grid.Column="2" Orientation="Horizontal" VerticalAlignment="Center">
                    <Image Source="pack://application:,,,/Resources/app.ico" Width="16" Height="16" Margin="0,0,6,0" VerticalAlignment="Center"/>
                    <TextBlock VerticalAlignment="Center">
                        <Hyperlink NavigateUri="https://www.meshhessen.de" RequestNavigate="Hyperlink_RequestNavigate">
                            <Run Text="www.meshhessen.de" FontWeight="Bold"/>
                        </Hyperlink>
                    </TextBlock>
                </StackPanel>
            </Grid>
        </Border>
    </Grid>
</Window>
