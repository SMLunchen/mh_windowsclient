<Window x:Class="MeshhessenClient.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:ui="http://schemas.modernwpf.com/2019"
        xmlns:mapsui="clr-namespace:Mapsui.UI.Wpf;assembly=Mapsui.UI.Wpf"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:converters="clr-namespace:MeshhessenClient.Converters"
        mc:Ignorable="d"
        ui:WindowHelper.UseModernWindowStyle="True"
        Icon="pack://application:,,,/Resources/app.ico"
        Title="Meshhessen Client v1.5.1"
        Height="650"
        Width="1000"
        MinHeight="450"
        MinWidth="700">
    <Window.Resources>
        <converters:MqttIconConverter x:Key="MqttIconConverter"/>
        <converters:MqttTooltipConverter x:Key="MqttTooltipConverter"/>
        <converters:AlertBellIconConverter x:Key="AlertBellIconConverter"/>
        <converters:HexToColorConverter x:Key="HexToColorConverter"/>
        <converters:IsNotEmptyConverter x:Key="IsNotEmptyConverter"/>
        <converters:NoteToParenthesesConverter x:Key="NoteToParenthesesConverter"/>

        <Style TargetType="ComboBoxItem">
            <Setter Property="Foreground" Value="{DynamicResource SystemControlForegroundBaseHighBrush}"/>
        </Style>
    </Window.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Alert Bell Overlay (Blinkt bei Notruf) -->
        <Border x:Name="AlertBellOverlay"
                Grid.RowSpan="4"
                BorderBrush="Red"
                BorderThickness="8"
                Visibility="Collapsed"
                IsHitTestVisible="False">
            <Border.Effect>
                <DropShadowEffect Color="Red" ShadowDepth="0" BlurRadius="20" Opacity="0.8"/>
            </Border.Effect>
        </Border>

        <!-- Alert Notification Bar -->
        <Border x:Name="AlertNotificationBar"
                Grid.Row="0"
                Background="#FFCC0000"
                Padding="10,8"
                Visibility="Collapsed">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <TextBlock Grid.Column="0"
                          Text="🚨"
                          FontSize="16"
                          VerticalAlignment="Center"
                          Margin="0,0,10,0"/>

                <TextBlock x:Name="AlertNotificationText"
                          Grid.Column="1"
                          Text="Notruf empfangen!"
                          Foreground="White"
                          FontWeight="Bold"
                          VerticalAlignment="Center"/>

                <Button x:Name="ShowOnMapButton"
                       Grid.Column="2"
                       Content="📍 Zur Karte"
                       Margin="10,0,10,0"
                       Padding="10,5"
                       Background="White"
                       Foreground="Black"
                       FontWeight="Bold"
                       Click="ShowOnMap_Click"
                       Visibility="Collapsed"/>

                <Button Grid.Column="3"
                       Content="✖"
                       Padding="8,2"
                       Background="Transparent"
                       Foreground="White"
                       BorderThickness="0"
                       FontWeight="Bold"
                       FontSize="14"
                       Click="CloseAlertNotification_Click"
                       Cursor="Hand"/>
            </Grid>
        </Border>

        <!-- Toolbar -->
        <Border Grid.Row="1" Background="{DynamicResource SystemControlBackgroundChromeMediumBrush}" Padding="10">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <!-- Connection Controls -->
                <StackPanel Grid.Column="0" Orientation="Horizontal">
                    <!-- Connection Type Radio Buttons -->
                    <StackPanel Orientation="Horizontal" Margin="0,0,8,0">
                        <RadioButton x:Name="SerialRadioButton"
                                    Content="📟 Serial"
                                    GroupName="ConnectionType"
                                    IsChecked="True"
                                    Checked="ConnectionTypeRadio_Changed"
                                    Tag="Serial"
                                    VerticalAlignment="Center"
                                    HorizontalAlignment="Left"
                                    Margin="0,0,5,0"
                                    FontSize="12"
                                    MinWidth="0"/>
                        <RadioButton x:Name="BluetoothRadioButton"
                                    Content="📡 Bluetooth"
                                    GroupName="ConnectionType"
                                    Checked="ConnectionTypeRadio_Changed"
                                    Tag="Bluetooth"
                                    VerticalAlignment="Center"
                                    HorizontalAlignment="Left"
                                    Margin="0,0,5,0"
                                    FontSize="12"
                                    MinWidth="0"/>
                        <RadioButton x:Name="WifiRadioButton"
                                    Content="🌐 WiFi"
                                    GroupName="ConnectionType"
                                    Checked="ConnectionTypeRadio_Changed"
                                    Tag="Tcp"
                                    VerticalAlignment="Center"
                                    HorizontalAlignment="Left"
                                    Margin="0,0,5,0"
                                    FontSize="12"
                                    MinWidth="0"/>
                    </StackPanel>

                    <!-- Serial Connection UI -->
                    <StackPanel x:Name="SerialConnectionPanel" Orientation="Horizontal" Visibility="Visible">
                        <TextBlock Text="Port:" VerticalAlignment="Center" Margin="0,0,5,0"/>
                        <ComboBox x:Name="PortComboBox"
                                 Width="120"
                                 VerticalAlignment="Center"
                                 SelectionChanged="PortComboBox_SelectionChanged"/>
                        <Button x:Name="RefreshPortsButton"
                               Content="🔄"
                               Margin="5,0,0,0"
                               Width="45"
                               ToolTip="Ports aktualisieren"
                               Click="RefreshPorts_Click"/>
                    </StackPanel>

                    <!-- Bluetooth Connection UI -->
                    <StackPanel x:Name="BluetoothConnectionPanel" Orientation="Horizontal" Visibility="Collapsed">
                        <TextBlock Text="Gerät:" VerticalAlignment="Center" Margin="0,0,5,0"/>
                        <ComboBox x:Name="BluetoothDeviceComboBox"
                                 Width="170"
                                 VerticalAlignment="Center"
                                 DisplayMemberPath="DisplayName"/>
                        <Button x:Name="ScanBluetoothButton"
                               Content="🔍"
                               Margin="5,0,0,0"
                               Width="40"
                               ToolTip="Geräte suchen"
                               Click="ScanBluetooth_Click"/>
                    </StackPanel>

                    <!-- TCP Connection UI -->
                    <StackPanel x:Name="TcpConnectionPanel" Orientation="Horizontal" Visibility="Collapsed">
                        <TextBlock Text="Host:" VerticalAlignment="Center" Margin="0,0,5,0"/>
                        <TextBox x:Name="TcpHostTextBox"
                                Width="120"
                                VerticalAlignment="Center"
                                Text="192.168.1.1"/>
                        <TextBlock Text="Port:" VerticalAlignment="Center" Margin="8,0,5,0"/>
                        <TextBox x:Name="TcpPortTextBox"
                                Width="50"
                                VerticalAlignment="Center"
                                Text="4403"/>
                    </StackPanel>

                    <Button x:Name="ConnectButton"
                           Content="Verbinden"
                           Margin="8,0,0,0"
                           Click="Connect_Click"/>
                    <TextBlock x:Name="StationNameLabel"
                               Text=""
                               FontSize="14"
                               FontWeight="Bold"
                               Foreground="Red"
                               VerticalAlignment="Center"
                               Margin="10,0,0,0"/>
                </StackPanel>

                <!-- Connection Status -->
                <StackPanel Grid.Column="1" Orientation="Horizontal">
                    <Button x:Name="OpenDmWindowButton"
                           Content="💬 DMs"
                           Margin="0,0,10,0"
                           Click="OpenDmWindow_Click"
                           ToolTip="Direktnachrichten öffnen"/>
                    <Ellipse x:Name="StatusIndicator"
                            Width="12"
                            Height="12"
                            Fill="Gray"
                            Margin="0,0,8,0"/>
                    <TextBlock x:Name="StatusText"
                              Text="Nicht verbunden"
                              VerticalAlignment="Center"/>
                </StackPanel>
            </Grid>
        </Border>

        <!-- Main Content Area -->
        <TabControl x:Name="MainTabs" Grid.Row="2" Margin="0">

            <!-- Messages Tab -->
            <TabItem Header="📨 Nachrichten">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>

                    <!-- Message Filter -->
                    <Grid Grid.Row="0" Margin="10,10,10,5">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        <TextBlock Grid.Column="0" Text="Kanal filtern:" VerticalAlignment="Center" Margin="0,0,10,0"/>
                        <ComboBox x:Name="MessageChannelFilterComboBox"
                                 Grid.Column="1"
                                 Width="200"
                                 VerticalAlignment="Center"
                                 SelectionChanged="MessageChannelFilter_Changed"
                                 DisplayMemberPath="Name"/>
                        <Image x:Name="mh_logo_wide_top" Grid.Column="2" Height="56" Width="286"
                               Source="/logo_mh_wide.jpg" HorizontalAlignment="Right"/>
                    </Grid>

                    <!-- Message List -->
                    <ListView x:Name="MessageListView"
                             Grid.Row="1"
                             Margin="10,5,10,10">
                        <ListView.View>
                            <GridView>
                                <GridViewColumn Header="" Width="50">
                                    <GridViewColumn.CellTemplate>
                                        <DataTemplate>
                                            <TextBlock Text="{Binding IsViaMqtt, Converter={StaticResource MqttIconConverter}}"
                                                       ToolTip="{Binding IsViaMqtt, Converter={StaticResource MqttTooltipConverter}}"
                                                       FontSize="16"
                                                       HorizontalAlignment="Center"/>
                                        </DataTemplate>
                                    </GridViewColumn.CellTemplate>
                                </GridViewColumn>
                                <GridViewColumn Header="🔔" Width="50">
                                    <GridViewColumn.CellTemplate>
                                        <DataTemplate>
                                            <TextBlock Text="{Binding HasAlertBell, Converter={StaticResource AlertBellIconConverter}}"
                                                       ToolTip="Diese Nachricht enthält ein Alert Bell"
                                                       FontSize="18"
                                                       Foreground="Red"
                                                       FontWeight="Bold"
                                                       HorizontalAlignment="Center"/>
                                        </DataTemplate>
                                    </GridViewColumn.CellTemplate>
                                </GridViewColumn>
                                <GridViewColumn Header="🎨" Width="50">
                                    <GridViewColumn.CellTemplate>
                                        <DataTemplate>
                                            <Border Width="20" Height="20"
                                                    BorderBrush="Gray"
                                                    BorderThickness="1"
                                                    Background="{Binding SenderColorHex, Converter={StaticResource HexToColorConverter}}"
                                                    Visibility="{Binding SenderColorHex, Converter={StaticResource IsNotEmptyConverter}}"/>
                                        </DataTemplate>
                                    </GridViewColumn.CellTemplate>
                                </GridViewColumn>
                                <GridViewColumn Header="Zeit" Width="120" DisplayMemberBinding="{Binding Time}"/>
                                <GridViewColumn Header="Von" Width="120" DisplayMemberBinding="{Binding From}"/>
                                <GridViewColumn Header="Notiz" Width="100">
                                    <GridViewColumn.CellTemplate>
                                        <DataTemplate>
                                            <TextBlock Text="{Binding SenderNote}" FontStyle="Italic"/>
                                        </DataTemplate>
                                    </GridViewColumn.CellTemplate>
                                </GridViewColumn>
                                <GridViewColumn Header="Nachricht" Width="300" DisplayMemberBinding="{Binding Message}"/>
                                <GridViewColumn Header="Kanal" Width="80" DisplayMemberBinding="{Binding ChannelName}"/>
                            </GridView>
                        </ListView.View>
                    </ListView>

                    <!-- Send Message -->
                    <Grid Grid.Row="2" Margin="10">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>

                        <!-- Channel Selection -->
                        <StackPanel Grid.Column="0" Orientation="Horizontal" VerticalAlignment="Center" Margin="0,0,10,0">
                            <TextBlock Text="Kanal:" VerticalAlignment="Center" Margin="0,0,10,0" FontWeight="Bold"/>
                            <ComboBox x:Name="ActiveChannelComboBox"
                                     Width="150"
                                     VerticalAlignment="Center"
                                     SelectionChanged="ActiveChannelComboBox_SelectionChanged"
                                     DisplayMemberPath="Name"
                                     IsEnabled="False"/>
                        </StackPanel>

                        <TextBox x:Name="MessageTextBox"
                                Grid.Column="1"
                                ui:ControlHelper.PlaceholderText="Nachricht eingeben..."
                                VerticalContentAlignment="Center"
                                Padding="10"
                                KeyDown="MessageTextBox_KeyDown"/>

                        <Button x:Name="AlertBellButton"
                               Grid.Column="2"
                               Content="🚨 SOS"
                               Width="80"
                               Margin="10,0,0,0"
                               Background="#FFCC0000"
                               Foreground="White"
                               FontWeight="Bold"
                               ToolTip="Notruf senden (Alert Bell)"
                               Click="AlertBell_Click"/>

                        <Button x:Name="SendButton"
                               Grid.Column="3"
                               Content="Senden"
                               Width="100"
                               Margin="10,0,0,0"
                               Click="Send_Click"/>
                    </Grid>
                </Grid>
            </TabItem>

            <!-- Nodes Tab -->
            <TabItem Header="🌐 Knoten">
                <Grid Margin="10">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>

                    <!-- Quick Filter -->
                    <TextBox x:Name="NodeFilterTextBox"
                             Grid.Row="0"
                             Margin="0,0,0,10"
                             TextChanged="NodeFilterTextBox_TextChanged"
                             Tag="🔍 Filter nach Name, ID, SNR, Batterie..."/>

                    <ListView x:Name="NodesListView" Grid.Row="1">
                        <ListView.View>
                            <GridView x:Name="NodesGridView">
                                <GridViewColumn Width="30">
                                    <GridViewColumn.Header>
                                        <GridViewColumnHeader Content="🎨"/>
                                    </GridViewColumn.Header>
                                    <GridViewColumn.CellTemplate>
                                        <DataTemplate>
                                            <Border Width="16" Height="16"
                                                    BorderBrush="Gray"
                                                    BorderThickness="1"
                                                    Background="{Binding ColorHex, Converter={StaticResource HexToColorConverter}}"
                                                    Visibility="{Binding ColorHex, Converter={StaticResource IsNotEmptyConverter}}"/>
                                        </DataTemplate>
                                    </GridViewColumn.CellTemplate>
                                </GridViewColumn>
                                <GridViewColumn Width="150">
                                    <GridViewColumn.Header>
                                        <GridViewColumnHeader Content="Name" Click="NodeColumnHeader_Click" Tag="Name"/>
                                    </GridViewColumn.Header>
                                    <GridViewColumn.DisplayMemberBinding>
                                        <Binding Path="Name"/>
                                    </GridViewColumn.DisplayMemberBinding>
                                </GridViewColumn>
                                <GridViewColumn Width="80">
                                    <GridViewColumn.Header>
                                        <GridViewColumnHeader Content="Kurz" Click="NodeColumnHeader_Click" Tag="ShortName"/>
                                    </GridViewColumn.Header>
                                    <GridViewColumn.DisplayMemberBinding>
                                        <Binding Path="ShortName"/>
                                    </GridViewColumn.DisplayMemberBinding>
                                </GridViewColumn>
                                <GridViewColumn Width="120">
                                    <GridViewColumn.Header>
                                        <GridViewColumnHeader Content="ID" Click="NodeColumnHeader_Click" Tag="Id"/>
                                    </GridViewColumn.Header>
                                    <GridViewColumn.DisplayMemberBinding>
                                        <Binding Path="Id"/>
                                    </GridViewColumn.DisplayMemberBinding>
                                </GridViewColumn>
                                <GridViewColumn Width="100">
                                    <GridViewColumn.Header>
                                        <GridViewColumnHeader Content="Entfernung" Click="NodeColumnHeader_Click" Tag="Distance"/>
                                    </GridViewColumn.Header>
                                    <GridViewColumn.DisplayMemberBinding>
                                        <Binding Path="Distance"/>
                                    </GridViewColumn.DisplayMemberBinding>
                                </GridViewColumn>
                                <GridViewColumn Width="80">
                                    <GridViewColumn.Header>
                                        <GridViewColumnHeader Content="SNR" Click="NodeColumnHeader_Click" Tag="Snr"/>
                                    </GridViewColumn.Header>
                                    <GridViewColumn.DisplayMemberBinding>
                                        <Binding Path="Snr"/>
                                    </GridViewColumn.DisplayMemberBinding>
                                </GridViewColumn>
                                <GridViewColumn Width="80">
                                    <GridViewColumn.Header>
                                        <GridViewColumnHeader Content="RSSI" Click="NodeColumnHeader_Click" Tag="Rssi"/>
                                    </GridViewColumn.Header>
                                    <GridViewColumn.DisplayMemberBinding>
                                        <Binding Path="Rssi"/>
                                    </GridViewColumn.DisplayMemberBinding>
                                </GridViewColumn>
                                <GridViewColumn Width="80">
                                    <GridViewColumn.Header>
                                        <GridViewColumnHeader Content="Batterie" Click="NodeColumnHeader_Click" Tag="Battery"/>
                                    </GridViewColumn.Header>
                                    <GridViewColumn.DisplayMemberBinding>
                                        <Binding Path="Battery"/>
                                    </GridViewColumn.DisplayMemberBinding>
                                </GridViewColumn>
                                <GridViewColumn Width="150">
                                    <GridViewColumn.Header>
                                        <GridViewColumnHeader Content="Zuletzt gesehen" Click="NodeColumnHeader_Click" Tag="LastSeen"/>
                                    </GridViewColumn.Header>
                                    <GridViewColumn.DisplayMemberBinding>
                                        <Binding Path="LastSeen"/>
                                    </GridViewColumn.DisplayMemberBinding>
                                </GridViewColumn>
                            </GridView>
                        </ListView.View>
                        <ListView.ContextMenu>
                            <ContextMenu>
                                <MenuItem Header="💬 DM senden" Click="SendDmToNode_Click"/>
                                <Separator/>
                                <MenuItem Header="🎨 Farbe setzen">
                                    <MenuItem Tag="#00FF00" Click="SetNodeColor_Click">
                                        <MenuItem.Header>
                                            <TextBlock Text="■ Grün" Foreground="#00FF00" FontWeight="Bold"/>
                                        </MenuItem.Header>
                                    </MenuItem>
                                    <MenuItem Tag="#0080FF" Click="SetNodeColor_Click">
                                        <MenuItem.Header>
                                            <TextBlock Text="■ Blau" Foreground="#0080FF" FontWeight="Bold"/>
                                        </MenuItem.Header>
                                    </MenuItem>
                                    <MenuItem Tag="#FFFF00" Click="SetNodeColor_Click">
                                        <MenuItem.Header>
                                            <TextBlock Text="■ Gelb" Foreground="#FFFF00" FontWeight="Bold"/>
                                        </MenuItem.Header>
                                    </MenuItem>
                                    <MenuItem Tag="#FF8000" Click="SetNodeColor_Click">
                                        <MenuItem.Header>
                                            <TextBlock Text="■ Orange" Foreground="#FF8000" FontWeight="Bold"/>
                                        </MenuItem.Header>
                                    </MenuItem>
                                    <MenuItem Tag="#8000FF" Click="SetNodeColor_Click">
                                        <MenuItem.Header>
                                            <TextBlock Text="■ Lila" Foreground="#8000FF" FontWeight="Bold"/>
                                        </MenuItem.Header>
                                    </MenuItem>
                                    <MenuItem Tag="#804000" Click="SetNodeColor_Click">
                                        <MenuItem.Header>
                                            <TextBlock Text="■ Braun" Foreground="#804000" FontWeight="Bold"/>
                                        </MenuItem.Header>
                                    </MenuItem>
                                    <MenuItem Tag="#FF00FF" Click="SetNodeColor_Click">
                                        <MenuItem.Header>
                                            <TextBlock Text="■ Pink" Foreground="#FF00FF" FontWeight="Bold"/>
                                        </MenuItem.Header>
                                    </MenuItem>
                                    <MenuItem Tag="#00FFFF" Click="SetNodeColor_Click">
                                        <MenuItem.Header>
                                            <TextBlock Text="■ Türkis" Foreground="#00FFFF" FontWeight="Bold"/>
                                        </MenuItem.Header>
                                    </MenuItem>
                                    <Separator/>
                                    <MenuItem Header="❌ Farbe entfernen" Click="RemoveNodeColor_Click"/>
                                </MenuItem>
                                <MenuItem Header="📝 Notiz bearbeiten..." Click="EditNodeNote_Click"/>
                            </ContextMenu>
                        </ListView.ContextMenu>
                    </ListView>
                </Grid>
            </TabItem>

            <!-- Channels Tab -->
            <TabItem Header="📡 Kanäle">
                <Grid Margin="10">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>

                    <ListView x:Name="ChannelsListView" Grid.Row="0">
                        <ListView.View>
                            <GridView>
                                <GridViewColumn Header="Index" Width="60" DisplayMemberBinding="{Binding Index}"/>
                                <GridViewColumn Header="Name" Width="150" DisplayMemberBinding="{Binding Name}"/>
                                <GridViewColumn Header="PSK" Width="300" DisplayMemberBinding="{Binding Psk}"/>
                                <GridViewColumn Header="Role" Width="100" DisplayMemberBinding="{Binding Role}"/>
                            </GridView>
                        </ListView.View>
                    </ListView>

                    <StackPanel Grid.Row="1" Orientation="Horizontal" Margin="0,10,0,0">
                        <Button Content="Kanal hinzufügen" Margin="0,0,10,0" Click="AddChannel_Click"/>
                        <Button Content="Kanal bearbeiten" Margin="0,0,10,0" Click="EditChannel_Click"/>
                        <Button Content="Kanal löschen" Click="DeleteChannel_Click"/>
                    </StackPanel>
                </Grid>
            </TabItem>

            <!-- Settings Tab -->
            <TabItem Header="⚙️ Einstellungen">
                <ScrollViewer VerticalScrollBarVisibility="Auto">
                    <StackPanel Margin="20">
                        <TextBlock Text="Geräteeinstellungen" FontSize="18" FontWeight="Bold" Margin="0,0,0,20"/>

                        <GroupBox Header="Radio Einstellungen" Margin="0,0,0,20">
                            <StackPanel Margin="10">
                                <StackPanel Orientation="Horizontal" Margin="0,10,0,10">
                                    <TextBlock Text="Region:" Width="150" VerticalAlignment="Center"/>
                                    <ComboBox x:Name="RegionComboBox" Width="200"/>
                                </StackPanel>
                                <StackPanel Orientation="Horizontal" Margin="0,10,0,10">
                                    <TextBlock Text="Modem Preset:" Width="150" VerticalAlignment="Center"/>
                                    <ComboBox x:Name="ModemPresetComboBox" Width="200"/>
                                </StackPanel>
                            </StackPanel>
                        </GroupBox>

                        <GroupBox Header="Geräteinfo" Margin="0,0,0,20">
                            <StackPanel Margin="10">
                                <StackPanel Orientation="Horizontal" Margin="0,10,0,10">
                                    <TextBlock Text="Name:" Width="150" VerticalAlignment="Center"/>
                                    <TextBox x:Name="DeviceNameTextBox" Width="200"/>
                                </StackPanel>
                                <StackPanel Orientation="Horizontal" Margin="0,10,0,10">
                                    <TextBlock Text="Hardware Model:" Width="150" VerticalAlignment="Center"/>
                                    <TextBlock x:Name="HardwareModelText" Width="200"/>
                                </StackPanel>
                                <StackPanel Orientation="Horizontal" Margin="0,10,0,10">
                                    <TextBlock Text="Firmware Version:" Width="150" VerticalAlignment="Center"/>
                                    <TextBlock x:Name="FirmwareVersionText" Width="200"/>
                                </StackPanel>
                            </StackPanel>
                        </GroupBox>

                        <GroupBox Header="Darstellung" Margin="0,0,0,20">
                            <StackPanel Margin="10">
                                <StackPanel Orientation="Horizontal" Margin="0,10,0,10">
                                <TextBlock Text="Stationsname:" Width="150" VerticalAlignment="Center"/>
                                <TextBox x:Name="StationNameTextBox" Width="200"/>
                            </StackPanel>
                            <TextBlock Text="Wird rechts neben dem Verbinden-Button angezeigt."
                                      FontStyle="Italic"
                                      Foreground="Gray"
                                      TextWrapping="Wrap"
                                      Margin="20,0,0,10"/>
                        <CheckBox x:Name="DarkModeCheckBox"
                                         Content="Dark Mode"
                                         Margin="0,10,0,10"
                                         IsChecked="False"
                                         Checked="DarkMode_Changed"
                                         Unchecked="DarkMode_Changed"/>
                                <TextBlock Text="Dunkles Farbschema für die Anwendung."
                                          FontStyle="Italic"
                                          Foreground="Gray"
                                          TextWrapping="Wrap"
                                          Margin="20,0,0,10"/>
                            </StackPanel>
                        </GroupBox>

                        <GroupBox Header="Nachrichten Anzeige" Margin="0,0,0,20">
                            <StackPanel Margin="10">
                                <CheckBox x:Name="ShowEncryptedMessagesCheckBox"
                                         Content="Verschlüsselte Nachrichten anzeigen (ohne PSK)"
                                         Margin="0,10,0,10"
                                         IsChecked="True"/>
                                <TextBlock Text="Wenn deaktiviert, werden verschlüsselte Nachrichten ausgeblendet."
                                          FontStyle="Italic"
                                          Foreground="Gray"
                                          TextWrapping="Wrap"
                                          Margin="20,0,0,10"/>
                            </StackPanel>
                        </GroupBox>

                        <GroupBox Header="Karte / Offline Tiles" Margin="0,0,0,20">
                            <StackPanel Margin="10">
                                <TextBlock Text="OSM Tiles herunterladen und im Ordner 'maptiles' speichern."
                                          FontStyle="Italic"
                                          Foreground="Gray"
                                          TextWrapping="Wrap"
                                          Margin="0,0,0,10"/>

                                <!-- Kartenquelle Auswahl -->
                                <TextBlock Text="Kartenquelle:" Margin="0,0,0,4"/>
                                <ComboBox x:Name="MapSourceComboBox"
                                         Width="250"
                                         HorizontalAlignment="Left"
                                         Margin="0,0,0,10"
                                         SelectionChanged="MapSourceComboBox_SelectionChanged">
                                    <ComboBoxItem Content="OpenStreetMap Standard" Tag="osm"/>
                                    <ComboBoxItem Content="OpenTopoMap" Tag="osmtopo"/>
                                    <ComboBoxItem Content="OpenStreetMap Dark" Tag="osmdark"/>
                                </ComboBox>

                                <!-- Tile-Server URL -->
                                <TextBlock Text="Tile-Server URL:" Margin="0,0,0,4"/>
                                <TextBox x:Name="TileServerUrlTextBox"
                                         Width="550"
                                         HorizontalAlignment="Left"
                                         Margin="0,0,0,4"/>
                                <TextBlock Text="Vollständige Tile-URL (http:// oder https://) mit Platzhaltern {z}, {x}, {y}. Beispiel: https://tile.server.de/osm/{z}/{x}/{y}.png"
                                          FontStyle="Italic"
                                          Foreground="Gray"
                                          TextWrapping="Wrap"
                                          FontSize="11"
                                          Margin="0,0,0,10"/>

                                <Button Content="Tiles herunterladen..."
                                       Width="200"
                                       HorizontalAlignment="Left"
                                       Margin="0,0,0,6"
                                       Click="DownloadTiles_Click"/>

                                <Button Content="Maptiles aus Zip laden..."
                                       Width="200"
                                       HorizontalAlignment="Left"
                                       Click="ImportTilesFromZip_Click"/>
                            </StackPanel>
                        </GroupBox>

                        <GroupBox Header="Benachrichtigungen" Margin="0,0,0,20">
                            <StackPanel Margin="10">
                                <CheckBox x:Name="AlertBellSoundCheckBox"
                                         Content="Ton bei Alert Bell abspielen (🔔)"
                                         Margin="0,0,0,4"/>
                                <TextBlock Text="Spielt einen Benachrichtigungston ab, wenn eine Nachricht das Meshtastic Alert Bell Character (ASCII 7) enthält."
                                          FontStyle="Italic"
                                          Foreground="Gray"
                                          TextWrapping="Wrap"
                                          FontSize="11"
                                          Margin="0,0,0,10"/>
                            </StackPanel>
                        </GroupBox>

                        <GroupBox Header="Debug" Margin="0,0,0,20">
                            <StackPanel>
                                <CheckBox x:Name="DebugMessagesCheckBox"
                                         Content="Nachrichten-Debug aktivieren (Details im Log)"
                                         Margin="0,0,0,10"/>
                                <TextBlock Text="Zeigt detaillierte Informationen über empfangene und gefilterte Nachrichten im Log an."
                                          TextWrapping="Wrap"
                                          FontSize="11"
                                          Foreground="Gray"
                                          Margin="0,0,0,15"/>
                                <CheckBox x:Name="DebugSerialCheckBox"
                                         Content="Serielle Daten-Debug aktivieren (Hex-Dump)"
                                         Margin="0,0,0,10"/>
                                <TextBlock Text="Zeigt empfangene und gesendete Protobuf-Pakete als Hex-Dump im Log an. Sehr ausführlich!"
                                          TextWrapping="Wrap"
                                          FontSize="11"
                                          Foreground="Gray"
                                          Margin="0,0,0,15"/>
                                <CheckBox x:Name="DebugDeviceCheckBox"
                                         Content="Device-Log aktivieren (Serielle Debug-Ausgabe)"
                                         Margin="0,0,0,10"/>
                                <TextBlock Text="Zeigt die Debug-Ausgabe des Meshtastic-Geräts im Log an (DEBUG/INFO Zeilen). Kritische Fehler werden immer angezeigt."
                                          TextWrapping="Wrap"
                                          FontSize="11"
                                          Foreground="Gray"
                                          Margin="0,0,0,15"/>
                                <CheckBox x:Name="DebugBluetoothCheckBox"
                                         Content="Bluetooth-Debug aktivieren (BLE-Kommunikation)"
                                         Margin="0,0,0,10"/>
                                <TextBlock Text="Zeigt detaillierte BLE-Kommunikation (GATT-Operationen, Reads/Writes) im Log an. Sehr ausführlich!"
                                          TextWrapping="Wrap"
                                          FontSize="11"
                                          Foreground="Gray"/>
                            </StackPanel>
                        </GroupBox>

                        <Button Content="Einstellungen speichern"
                               Width="200"
                               HorizontalAlignment="Left"
                               Click="SaveSettings_Click"/>
                    </StackPanel>
                </ScrollViewer>
            </TabItem>

            <!-- Karte Tab -->
            <TabItem Header="🗺️ Karte">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>
                    <Grid Grid.Row="0" Margin="10,5">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        <StackPanel Grid.Column="0" Orientation="Horizontal">
                            <Button Content="+" Width="32" Height="32" Margin="0,0,4,0"
                                    Click="MapZoomIn_Click" ToolTip="Zoom In"/>
                            <Button Content="-" Width="32" Height="32" Margin="0,0,10,0"
                                    Click="MapZoomOut_Click" ToolTip="Zoom Out"/>
                        </StackPanel>
                        <TextBlock x:Name="MapStatusText" Grid.Column="1" VerticalAlignment="Center" Foreground="Gray" FontStyle="Italic"/>
                    </Grid>
                    <Grid Grid.Row="1">
                        <mapsui:MapControl x:Name="MapControl"/>
                        <!-- Copyright Hinweis rechts unten -->
                        <TextBlock x:Name="MapCopyrightText"
                                   HorizontalAlignment="Right"
                                   VerticalAlignment="Bottom"
                                   Margin="0,0,8,4"
                                   FontSize="10"
                                   Foreground="Gray"
                                   Background="#99FFFFFF"
                                   Padding="4,2"
                                   TextWrapping="Wrap"
                                   MaxWidth="400"
                                   Text="© OpenStreetMap contributors"/>
                    </Grid>
                </Grid>
            </TabItem>

            <!-- Info Tab -->
            <TabItem Header="ℹ️ Info">
                <ScrollViewer VerticalScrollBarVisibility="Auto">
                    <StackPanel Margin="20">
                        <TextBlock Text="Meshhessen Client" FontSize="24" FontWeight="Bold" Margin="0,0,0,4"/>
                        <TextBlock Text="v1.5.1" FontSize="16" Foreground="Gray" Margin="0,0,0,16"/>
                        <TextBlock Text="Offline-fähiger Windows-Client für Meshtastic-Geräte mit Kartenansicht, Kanalverwaltung und Multi-Verbindungsunterstützung (Serial, TCP/WiFi, Bluetooth)."
                                  TextWrapping="Wrap" Margin="0,0,0,20"/>

                        <TextBlock Text="Lizenzen &amp; Danksagungen" FontSize="18" FontWeight="Bold" Margin="0,0,0,12"/>

                        <Border BorderBrush="{DynamicResource SystemControlForegroundBaseMediumLowBrush}" BorderThickness="0,0,0,1" Padding="0,0,0,10" Margin="0,0,0,10">
                            <StackPanel>
                                <TextBlock Text="OpenStreetMap" FontWeight="Bold"/>
                                <TextBlock Text="Kartendaten © OpenStreetMap-Mitwirkende" TextWrapping="Wrap"/>
                                <TextBlock Text="Lizenz: Open Data Commons Open Database License (ODbL)" Foreground="Gray" FontSize="11"/>
                                <TextBlock TextWrapping="Wrap" FontSize="11" Foreground="Gray">
                                    <Hyperlink NavigateUri="https://www.openstreetmap.org/copyright" RequestNavigate="Hyperlink_RequestNavigate">
                                        <Run Text="openstreetmap.org/copyright"/>
                                    </Hyperlink>
                                </TextBlock>
                            </StackPanel>
                        </Border>

                        <Border BorderBrush="{DynamicResource SystemControlForegroundBaseMediumLowBrush}" BorderThickness="0,0,0,1" Padding="0,0,0,10" Margin="0,0,0,10">
                            <StackPanel>
                                <TextBlock Text="OpenTopoMap" FontWeight="Bold"/>
                                <TextBlock Text="Kartendarstellung © OpenTopoMap" TextWrapping="Wrap"/>
                                <TextBlock Text="Lizenz: CC-BY-SA" Foreground="Gray" FontSize="11"/>
                                <TextBlock TextWrapping="Wrap" FontSize="11" Foreground="Gray">
                                    <Hyperlink NavigateUri="https://opentopomap.org/about" RequestNavigate="Hyperlink_RequestNavigate">
                                        <Run Text="opentopomap.org/about"/>
                                    </Hyperlink>
                                </TextBlock>
                            </StackPanel>
                        </Border>

                        <Border BorderBrush="{DynamicResource SystemControlForegroundBaseMediumLowBrush}" BorderThickness="0,0,0,1" Padding="0,0,0,10" Margin="0,0,0,10">
                            <StackPanel>
                                <TextBlock Text="Meshtastic" FontWeight="Bold"/>
                                <TextBlock Text="Firmware und Protokoll für LoRa-Mesh-Netzwerke" TextWrapping="Wrap"/>
                                <TextBlock Text="Lizenz: GPL-3.0" Foreground="Gray" FontSize="11"/>
                                <TextBlock TextWrapping="Wrap" FontSize="11" Foreground="Gray">
                                    <Hyperlink NavigateUri="https://meshtastic.org" RequestNavigate="Hyperlink_RequestNavigate">
                                        <Run Text="meshtastic.org"/>
                                    </Hyperlink>
                                </TextBlock>
                            </StackPanel>
                        </Border>

                        <Border BorderBrush="{DynamicResource SystemControlForegroundBaseMediumLowBrush}" BorderThickness="0,0,0,1" Padding="0,0,0,10" Margin="0,0,0,10">
                            <StackPanel>
                                <TextBlock Text="Mapsui" FontWeight="Bold"/>
                                <TextBlock Text="Offline-Kartendarstellung für .NET" TextWrapping="Wrap"/>
                                <TextBlock Text="Lizenz: LGPL-3.0" Foreground="Gray" FontSize="11"/>
                                <TextBlock TextWrapping="Wrap" FontSize="11" Foreground="Gray">
                                    <Hyperlink NavigateUri="https://mapsui.com" RequestNavigate="Hyperlink_RequestNavigate">
                                        <Run Text="mapsui.com"/>
                                    </Hyperlink>
                                </TextBlock>
                            </StackPanel>
                        </Border>

                        <Border BorderBrush="{DynamicResource SystemControlForegroundBaseMediumLowBrush}" BorderThickness="0,0,0,1" Padding="0,0,0,10" Margin="0,0,0,10">
                            <StackPanel>
                                <TextBlock Text="BruTile" FontWeight="Bold"/>
                                <TextBlock Text="Tile-Schema und -Handling" TextWrapping="Wrap"/>
                                <TextBlock Text="Lizenz: Apache 2.0" Foreground="Gray" FontSize="11"/>
                            </StackPanel>
                        </Border>

                        <Border BorderBrush="{DynamicResource SystemControlForegroundBaseMediumLowBrush}" BorderThickness="0,0,0,1" Padding="0,0,0,10" Margin="0,0,0,10">
                            <StackPanel>
                                <TextBlock Text="ModernWPF" FontWeight="Bold"/>
                                <TextBlock Text="Fluent Design UI-Theming für WPF" TextWrapping="Wrap"/>
                                <TextBlock Text="Lizenz: MIT" Foreground="Gray" FontSize="11"/>
                            </StackPanel>
                        </Border>

                        <Border BorderBrush="{DynamicResource SystemControlForegroundBaseMediumLowBrush}" BorderThickness="0,0,0,1" Padding="0,0,0,10" Margin="0,0,0,10">
                            <StackPanel>
                                <TextBlock Text="Google Protobuf" FontWeight="Bold"/>
                                <TextBlock Text="Protokoll-Serialisierung für Meshtastic-Kommunikation" TextWrapping="Wrap"/>
                                <TextBlock Text="Lizenz: BSD-3-Clause" Foreground="Gray" FontSize="11"/>
                            </StackPanel>
                        </Border>

                        <Border Padding="0,10,0,0">
                            <StackPanel>
                                <TextBlock Text="Projekt" FontSize="18" FontWeight="Bold" Margin="0,0,0,8"/>
                                <TextBlock TextWrapping="Wrap" FontSize="11">
                                    <Hyperlink NavigateUri="https://www.meshhessen.de" RequestNavigate="Hyperlink_RequestNavigate">
                                        <Run Text="www.meshhessen.de"/>
                                    </Hyperlink>
                                </TextBlock>
                            </StackPanel>
                        </Border>
                    </StackPanel>
                </ScrollViewer>
            </TabItem>

            <!-- Debug Tab -->
            <TabItem Header="🐛 Debug">
                <Grid Margin="10">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>

                    <!-- Debug Controls -->
                    <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="0,0,0,10">
                        <Button x:Name="ClearLogButton"
                               Content="Log löschen"
                               Click="ClearLog_Click"
                               Margin="0,0,10,0"/>
                        <Button x:Name="CopyLogButton"
                               Content="Log kopieren"
                               Click="CopyLog_Click"
                               Margin="0,0,10,0"/>
                        <Button x:Name="OpenLogFileButton"
                               Content="Log-Datei öffnen"
                               Click="OpenLogFile_Click"/>
                    </StackPanel>

                    <!-- Debug Log Output -->
                    <TextBox x:Name="DebugLogTextBox"
                            Grid.Row="1"
                            IsReadOnly="True"
                            FontFamily="Consolas"
                            FontSize="12"
                            VerticalScrollBarVisibility="Auto"
                            HorizontalScrollBarVisibility="Auto"
                            TextWrapping="NoWrap"
                            Background="{DynamicResource SystemControlBackgroundBaseBrush}"/>
                </Grid>
            </TabItem>

        </TabControl>

        <!-- Status Bar -->
        <Border Grid.Row="3" Background="{DynamicResource SystemControlBackgroundChromeMediumLowBrush}" Padding="10,5">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <TextBlock x:Name="StatusBarText"
                          Text="Bereit"
                          VerticalAlignment="Center"/>

                <TextBlock x:Name="PacketCountText"
                          Grid.Column="1"
                          Text="Pakete: 0"
                          Margin="0,0,20,0"
                          VerticalAlignment="Center"/>

                <StackPanel Grid.Column="2" Orientation="Horizontal" VerticalAlignment="Center">
                    <TextBlock Text="v1.5.1" VerticalAlignment="Center" Foreground="Gray" Margin="0,0,12,0" FontSize="11"/>
                    <Image Source="pack://application:,,,/Resources/app.ico" Width="16" Height="16" Margin="0,0,6,0" VerticalAlignment="Center"/>
                    <TextBlock VerticalAlignment="Center">
                        <Hyperlink NavigateUri="https://www.meshhessen.de" RequestNavigate="Hyperlink_RequestNavigate">
                            <Run Text="www.meshhessen.de" FontWeight="Bold"/>
                        </Hyperlink>
                    </TextBlock>
                </StackPanel>
            </Grid>
        </Border>
    </Grid>
</Window>
